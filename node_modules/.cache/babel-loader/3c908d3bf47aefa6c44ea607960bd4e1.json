{"ast":null,"code":"import \"core-js/modules/es.error.cause.js\";\nimport { toArray } from './util';\nimport { shouldEmbed, embedResources } from './embedResources';\nconst cssFetchCache = {};\n\nfunction fetchCSS(url) {\n  const cache = cssFetchCache[url];\n\n  if (cache != null) {\n    return cache;\n  }\n\n  const deferred = window.fetch(url).then(res => ({\n    url,\n    cssText: res.text()\n  }));\n  cssFetchCache[url] = deferred;\n  return deferred;\n}\n\nasync function embedFonts(meta, options) {\n  return meta.cssText.then(raw => {\n    let cssText = raw;\n    const regexUrl = /url\\([\"']?([^\"')]+)[\"']?\\)/g;\n    const fontLocs = cssText.match(/url\\([^)]+\\)/g) || [];\n    const loadFonts = fontLocs.map(location => {\n      let url = location.replace(regexUrl, '$1');\n\n      if (!url.startsWith('https://')) {\n        url = new URL(url, meta.url).href;\n      } // eslint-disable-next-line promise/no-nesting\n\n\n      return window.fetch(url, options.fetchRequestInit).then(res => res.blob()).then(blob => new Promise((resolve, reject) => {\n        const reader = new FileReader();\n\n        reader.onloadend = () => {\n          // Side Effect\n          cssText = cssText.replace(location, `url(${reader.result})`);\n          resolve([location, reader.result]);\n        };\n\n        reader.onerror = reject;\n        reader.readAsDataURL(blob);\n      }));\n    }); // eslint-disable-next-line promise/no-nesting\n\n    return Promise.all(loadFonts).then(() => cssText);\n  });\n}\n\nfunction parseCSS(source) {\n  if (source == null) {\n    return [];\n  }\n\n  const result = [];\n  const commentsRegex = /(\\/\\*[\\s\\S]*?\\*\\/)/gi; // strip out comments\n\n  let cssText = source.replace(commentsRegex, ''); // eslint-disable-next-line prefer-regex-literals\n\n  const keyframesRegex = new RegExp('((@.*?keyframes [\\\\s\\\\S]*?){([\\\\s\\\\S]*?}\\\\s*?)})', 'gi'); // eslint-disable-next-line no-constant-condition\n\n  while (true) {\n    const matches = keyframesRegex.exec(cssText);\n\n    if (matches === null) {\n      break;\n    }\n\n    result.push(matches[0]);\n  }\n\n  cssText = cssText.replace(keyframesRegex, '');\n  const importRegex = /@import[\\s\\S]*?url\\([^)]*\\)[\\s\\S]*?;/gi; // to match css & media queries together\n\n  const combinedCSSRegex = '((\\\\s*?(?:\\\\/\\\\*[\\\\s\\\\S]*?\\\\*\\\\/)?\\\\s*?@media[\\\\s\\\\S]' + '*?){([\\\\s\\\\S]*?)}\\\\s*?})|(([\\\\s\\\\S]*?){([\\\\s\\\\S]*?)})'; // unified regex\n\n  const unifiedRegex = new RegExp(combinedCSSRegex, 'gi'); // eslint-disable-next-line no-constant-condition\n\n  while (true) {\n    let matches = importRegex.exec(cssText);\n\n    if (matches === null) {\n      matches = unifiedRegex.exec(cssText);\n\n      if (matches === null) {\n        break;\n      } else {\n        importRegex.lastIndex = unifiedRegex.lastIndex;\n      }\n    } else {\n      unifiedRegex.lastIndex = importRegex.lastIndex;\n    }\n\n    result.push(matches[0]);\n  }\n\n  return result;\n}\n\nasync function getCSSRules(styleSheets, options) {\n  const ret = [];\n  const deferreds = []; // First loop inlines imports\n\n  styleSheets.forEach(sheet => {\n    if ('cssRules' in sheet) {\n      try {\n        toArray(sheet.cssRules || []).forEach((item, index) => {\n          if (item.type === CSSRule.IMPORT_RULE) {\n            let importIndex = index + 1;\n            const url = item.href;\n            const deferred = fetchCSS(url).then(metadata => metadata ? embedFonts(metadata, options) : '').then(cssText => parseCSS(cssText).forEach(rule => {\n              try {\n                sheet.insertRule(rule, rule.startsWith('@import') ? importIndex += 1 : sheet.cssRules.length);\n              } catch (error) {\n                console.error('Error inserting rule from remote css', {\n                  rule,\n                  error\n                });\n              }\n            })).catch(e => {\n              console.error('Error loading remote css', e.toString());\n            });\n            deferreds.push(deferred);\n          }\n        });\n      } catch (e) {\n        const inline = styleSheets.find(a => a.href == null) || document.styleSheets[0];\n\n        if (sheet.href != null) {\n          deferreds.push(fetchCSS(sheet.href).then(metadata => metadata ? embedFonts(metadata, options) : '').then(cssText => parseCSS(cssText).forEach(rule => {\n            inline.insertRule(rule, sheet.cssRules.length);\n          })).catch(err => {\n            console.error('Error loading remote stylesheet', err.toString());\n          }));\n        }\n\n        console.error('Error inlining remote css file', e.toString());\n      }\n    }\n  });\n  return Promise.all(deferreds).then(() => {\n    // Second loop parses rules\n    styleSheets.forEach(sheet => {\n      if ('cssRules' in sheet) {\n        try {\n          toArray(sheet.cssRules || []).forEach(item => {\n            ret.push(item);\n          });\n        } catch (e) {\n          console.error(`Error while reading CSS rules from ${sheet.href}`, e.toString());\n        }\n      }\n    });\n    return ret;\n  });\n}\n\nfunction getWebFontRules(cssRules) {\n  return cssRules.filter(rule => rule.type === CSSRule.FONT_FACE_RULE).filter(rule => shouldEmbed(rule.style.getPropertyValue('src')));\n}\n\nasync function parseWebFontRules(node, options) {\n  return new Promise((resolve, reject) => {\n    if (node.ownerDocument == null) {\n      reject(new Error('Provided element is not within a Document'));\n    }\n\n    resolve(toArray(node.ownerDocument.styleSheets));\n  }).then(styleSheets => getCSSRules(styleSheets, options)).then(getWebFontRules);\n}\n\nexport async function getWebFontCSS(node, options) {\n  return parseWebFontRules(node, options).then(rules => Promise.all(rules.map(rule => {\n    const baseUrl = rule.parentStyleSheet ? rule.parentStyleSheet.href : null;\n    return embedResources(rule.cssText, baseUrl, options);\n  }))).then(cssTexts => cssTexts.join('\\n'));\n}\nexport async function embedWebFonts(clonedNode, options) {\n  return (options.fontEmbedCSS != null ? Promise.resolve(options.fontEmbedCSS) : getWebFontCSS(clonedNode, options)).then(cssText => {\n    const styleNode = document.createElement('style');\n    const sytleContent = document.createTextNode(cssText);\n    styleNode.appendChild(sytleContent);\n\n    if (clonedNode.firstChild) {\n      clonedNode.insertBefore(styleNode, clonedNode.firstChild);\n    } else {\n      clonedNode.appendChild(styleNode);\n    }\n\n    return clonedNode;\n  });\n}","map":{"version":3,"mappings":";AAAA,SAASA,OAAT,QAAwB,QAAxB;AAEA,SAASC,WAAT,EAAsBC,cAAtB,QAA4C,kBAA5C;AAOA,MAAMC,aAAa,GAEf,EAFJ;;AAIA,SAASC,QAAT,CAAkBC,GAAlB,EAA6B;EAC3B,MAAMC,KAAK,GAAGH,aAAa,CAACE,GAAD,CAA3B;;EACA,IAAIC,KAAK,IAAI,IAAb,EAAmB;IACjB,OAAOA,KAAP;EACD;;EAED,MAAMC,QAAQ,GAAGC,MAAM,CAACC,KAAP,CAAaJ,GAAb,EAAkBK,IAAlB,CAAwBC,GAAD,KAAU;IAChDN,GADgD;IAEhDO,OAAO,EAAED,GAAG,CAACE,IAAJ;EAFuC,CAAV,CAAvB,CAAjB;EAKAV,aAAa,CAACE,GAAD,CAAb,GAAqBE,QAArB;EAEA,OAAOA,QAAP;AACD;;AAED,eAAeO,UAAf,CAA0BC,IAA1B,EAA0CC,OAA1C,EAA0D;EACxD,OAAOD,IAAI,CAACH,OAAL,CAAaF,IAAb,CAAmBO,GAAD,IAAgB;IACvC,IAAIL,OAAO,GAAGK,GAAd;IACA,MAAMC,QAAQ,GAAG,6BAAjB;IACA,MAAMC,QAAQ,GAAGP,OAAO,CAACQ,KAAR,CAAc,eAAd,KAAkC,EAAnD;IACA,MAAMC,SAAS,GAAGF,QAAQ,CAACG,GAAT,CAAcC,QAAD,IAAqB;MAClD,IAAIlB,GAAG,GAAGkB,QAAQ,CAACC,OAAT,CAAiBN,QAAjB,EAA2B,IAA3B,CAAV;;MACA,IAAI,CAACb,GAAG,CAACoB,UAAJ,CAAe,UAAf,CAAL,EAAiC;QAC/BpB,GAAG,GAAG,IAAIqB,GAAJ,CAAQrB,GAAR,EAAaU,IAAI,CAACV,GAAlB,EAAuBsB,IAA7B;MACD,CAJiD,CAMlD;;;MACA,OAAOnB,MAAM,CACVC,KADI,CACEJ,GADF,EACOW,OAAO,CAACY,gBADf,EAEJlB,IAFI,CAEEC,GAAD,IAASA,GAAG,CAACkB,IAAJ,EAFV,EAGJnB,IAHI,CAIFmB,IAAD,IACE,IAAIC,OAAJ,CACE,CAACC,OAAD,EAAUC,MAAV,KAAoB;QAClB,MAAMC,MAAM,GAAG,IAAIC,UAAJ,EAAf;;QACAD,MAAM,CAACE,SAAP,GAAmB,MAAK;UACtB;UACAvB,OAAO,GAAGA,OAAO,CAACY,OAAR,CAAgBD,QAAhB,EAA0B,OAAOU,MAAM,CAACG,MAAM,GAA9C,CAAV;UACAL,OAAO,CAAC,CAACR,QAAD,EAAWU,MAAM,CAACG,MAAlB,CAAD,CAAP;QACD,CAJD;;QAKAH,MAAM,CAACI,OAAP,GAAiBL,MAAjB;QACAC,MAAM,CAACK,aAAP,CAAqBT,IAArB;MACD,CAVH,CALC,CAAP;IAkBD,CAzBiB,CAAlB,CAJuC,CA+BvC;;IACA,OAAOC,OAAO,CAACS,GAAR,CAAYlB,SAAZ,EAAuBX,IAAvB,CAA4B,MAAME,OAAlC,CAAP;EACD,CAjCM,CAAP;AAkCD;;AAED,SAAS4B,QAAT,CAAkBC,MAAlB,EAAgC;EAC9B,IAAIA,MAAM,IAAI,IAAd,EAAoB;IAClB,OAAO,EAAP;EACD;;EAED,MAAML,MAAM,GAAa,EAAzB;EACA,MAAMM,aAAa,GAAG,sBAAtB,CAN8B,CAO9B;;EACA,IAAI9B,OAAO,GAAG6B,MAAM,CAACjB,OAAP,CAAekB,aAAf,EAA8B,EAA9B,CAAd,CAR8B,CAU9B;;EACA,MAAMC,cAAc,GAAG,IAAIC,MAAJ,CACrB,kDADqB,EAErB,IAFqB,CAAvB,CAX8B,CAgB9B;;EACA,OAAO,IAAP,EAAa;IACX,MAAMC,OAAO,GAAGF,cAAc,CAACG,IAAf,CAAoBlC,OAApB,CAAhB;;IACA,IAAIiC,OAAO,KAAK,IAAhB,EAAsB;MACpB;IACD;;IACDT,MAAM,CAACW,IAAP,CAAYF,OAAO,CAAC,CAAD,CAAnB;EACD;;EACDjC,OAAO,GAAGA,OAAO,CAACY,OAAR,CAAgBmB,cAAhB,EAAgC,EAAhC,CAAV;EAEA,MAAMK,WAAW,GAAG,wCAApB,CA1B8B,CA2B9B;;EACA,MAAMC,gBAAgB,GACpB,0DACA,uDAFF,CA5B8B,CA+B9B;;EACA,MAAMC,YAAY,GAAG,IAAIN,MAAJ,CAAWK,gBAAX,EAA6B,IAA7B,CAArB,CAhC8B,CAiC9B;;EACA,OAAO,IAAP,EAAa;IACX,IAAIJ,OAAO,GAAGG,WAAW,CAACF,IAAZ,CAAiBlC,OAAjB,CAAd;;IACA,IAAIiC,OAAO,KAAK,IAAhB,EAAsB;MACpBA,OAAO,GAAGK,YAAY,CAACJ,IAAb,CAAkBlC,OAAlB,CAAV;;MACA,IAAIiC,OAAO,KAAK,IAAhB,EAAsB;QACpB;MACD,CAFD,MAEO;QACLG,WAAW,CAACG,SAAZ,GAAwBD,YAAY,CAACC,SAArC;MACD;IACF,CAPD,MAOO;MACLD,YAAY,CAACC,SAAb,GAAyBH,WAAW,CAACG,SAArC;IACD;;IACDf,MAAM,CAACW,IAAP,CAAYF,OAAO,CAAC,CAAD,CAAnB;EACD;;EAED,OAAOT,MAAP;AACD;;AAED,eAAegB,WAAf,CACEC,WADF,EAEErC,OAFF,EAEkB;EAEhB,MAAMsC,GAAG,GAAmB,EAA5B;EACA,MAAMC,SAAS,GAA6B,EAA5C,CAHgB,CAKhB;;EACAF,WAAW,CAACG,OAAZ,CAAqBC,KAAD,IAAU;IAC5B,IAAI,cAAcA,KAAlB,EAAyB;MACvB,IAAI;QACFzD,OAAO,CAAUyD,KAAK,CAACC,QAAN,IAAkB,EAA5B,CAAP,CAAuCF,OAAvC,CAA+C,CAACG,IAAD,EAAOC,KAAP,KAAgB;UAC7D,IAAID,IAAI,CAACE,IAAL,KAAcC,OAAO,CAACC,WAA1B,EAAuC;YACrC,IAAIC,WAAW,GAAGJ,KAAK,GAAG,CAA1B;YACA,MAAMvD,GAAG,GAAIsD,IAAsB,CAAChC,IAApC;YACA,MAAMpB,QAAQ,GAAGH,QAAQ,CAACC,GAAD,CAAR,CACdK,IADc,CACRuD,QAAD,IACJA,QAAQ,GAAGnD,UAAU,CAACmD,QAAD,EAAWjD,OAAX,CAAb,GAAmC,EAF9B,EAIdN,IAJc,CAIRE,OAAD,IACJ4B,QAAQ,CAAC5B,OAAD,CAAR,CAAkB4C,OAAlB,CAA2BU,IAAD,IAAS;cACjC,IAAI;gBACFT,KAAK,CAACU,UAAN,CACED,IADF,EAEEA,IAAI,CAACzC,UAAL,CAAgB,SAAhB,IACKuC,WAAW,IAAI,CADpB,GAEIP,KAAK,CAACC,QAAN,CAAeU,MAJrB;cAMD,CAPD,CAOE,OAAOC,KAAP,EAAc;gBACdC,OAAO,CAACD,KAAR,CAAc,sCAAd,EAAsD;kBACpDH,IADoD;kBAEpDG;gBAFoD,CAAtD;cAID;YACF,CAdD,CALa,EAqBdE,KArBc,CAqBPC,CAAD,IAAM;cACXF,OAAO,CAACD,KAAR,CAAc,0BAAd,EAA0CG,CAAC,CAACC,QAAF,EAA1C;YACD,CAvBc,CAAjB;YAyBAlB,SAAS,CAACR,IAAV,CAAexC,QAAf;UACD;QACF,CA/BD;MAgCD,CAjCD,CAiCE,OAAOiE,CAAP,EAAU;QACV,MAAME,MAAM,GACVrB,WAAW,CAACsB,IAAZ,CAAkBC,CAAD,IAAOA,CAAC,CAACjD,IAAF,IAAU,IAAlC,KAA2CkD,QAAQ,CAACxB,WAAT,CAAqB,CAArB,CAD7C;;QAEA,IAAII,KAAK,CAAC9B,IAAN,IAAc,IAAlB,EAAwB;UACtB4B,SAAS,CAACR,IAAV,CACE3C,QAAQ,CAACqD,KAAK,CAAC9B,IAAP,CAAR,CACGjB,IADH,CACSuD,QAAD,IACJA,QAAQ,GAAGnD,UAAU,CAACmD,QAAD,EAAWjD,OAAX,CAAb,GAAmC,EAF/C,EAIGN,IAJH,CAISE,OAAD,IACJ4B,QAAQ,CAAC5B,OAAD,CAAR,CAAkB4C,OAAlB,CAA2BU,IAAD,IAAS;YACjCQ,MAAM,CAACP,UAAP,CAAkBD,IAAlB,EAAwBT,KAAK,CAACC,QAAN,CAAeU,MAAvC;UACD,CAFD,CALJ,EASGG,KATH,CASUO,GAAD,IAAQ;YACbR,OAAO,CAACD,KAAR,CAAc,iCAAd,EAAiDS,GAAG,CAACL,QAAJ,EAAjD;UACD,CAXH,CADF;QAcD;;QACDH,OAAO,CAACD,KAAR,CAAc,gCAAd,EAAgDG,CAAC,CAACC,QAAF,EAAhD;MACD;IACF;EACF,CAzDD;EA2DA,OAAO3C,OAAO,CAACS,GAAR,CAAYgB,SAAZ,EAAuB7C,IAAvB,CAA4B,MAAK;IACtC;IACA2C,WAAW,CAACG,OAAZ,CAAqBC,KAAD,IAAU;MAC5B,IAAI,cAAcA,KAAlB,EAAyB;QACvB,IAAI;UACFzD,OAAO,CAAeyD,KAAK,CAACC,QAAN,IAAkB,EAAjC,CAAP,CAA4CF,OAA5C,CAAqDG,IAAD,IAAS;YAC3DL,GAAG,CAACP,IAAJ,CAASY,IAAT;UACD,CAFD;QAGD,CAJD,CAIE,OAAOa,CAAP,EAAU;UACVF,OAAO,CAACD,KAAR,CACE,sCAAsCZ,KAAK,CAAC9B,IAAI,EADlD,EAEE6C,CAAC,CAACC,QAAF,EAFF;QAID;MACF;IACF,CAbD;IAeA,OAAOnB,GAAP;EACD,CAlBM,CAAP;AAmBD;;AAED,SAASyB,eAAT,CAAyBrB,QAAzB,EAAiD;EAC/C,OAAOA,QAAQ,CACZsB,MADI,CACId,IAAD,IAAUA,IAAI,CAACL,IAAL,KAAcC,OAAO,CAACmB,cADnC,EAEJD,MAFI,CAEId,IAAD,IAAUjE,WAAW,CAACiE,IAAI,CAACgB,KAAL,CAAWC,gBAAX,CAA4B,KAA5B,CAAD,CAFxB,CAAP;AAGD;;AAED,eAAeC,iBAAf,CACEC,IADF,EAEErE,OAFF,EAEkB;EAEhB,OAAO,IAAIc,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAoB;IACrC,IAAIqD,IAAI,CAACC,aAAL,IAAsB,IAA1B,EAAgC;MAC9BtD,MAAM,CAAC,IAAIuD,KAAJ,CAAU,2CAAV,CAAD,CAAN;IACD;;IACDxD,OAAO,CAAC/B,OAAO,CAACqF,IAAI,CAACC,aAAL,CAAmBjC,WAApB,CAAR,CAAP;EACD,CALM,EAMJ3C,IANI,CAME2C,WAAD,IAAkCD,WAAW,CAACC,WAAD,EAAcrC,OAAd,CAN9C,EAOJN,IAPI,CAOCqE,eAPD,CAAP;AAQD;;AAED,OAAO,eAAeS,aAAf,CACLH,IADK,EAELrE,OAFK,EAEW;EAEhB,OAAOoE,iBAAiB,CAACC,IAAD,EAAOrE,OAAP,CAAjB,CACJN,IADI,CACE+E,KAAD,IACJ3D,OAAO,CAACS,GAAR,CACEkD,KAAK,CAACnE,GAAN,CAAW4C,IAAD,IAAS;IACjB,MAAMwB,OAAO,GAAGxB,IAAI,CAACyB,gBAAL,GACZzB,IAAI,CAACyB,gBAAL,CAAsBhE,IADV,GAEZ,IAFJ;IAGA,OAAOzB,cAAc,CAACgE,IAAI,CAACtD,OAAN,EAAe8E,OAAf,EAAwB1E,OAAxB,CAArB;EACD,CALD,CADF,CAFG,EAWJN,IAXI,CAWEkF,QAAD,IAAcA,QAAQ,CAACC,IAAT,CAAc,IAAd,CAXf,CAAP;AAYD;AAED,OAAO,eAAeC,aAAf,CACLC,UADK,EAEL/E,OAFK,EAEW;EAEhB,OAAO,CACLA,OAAO,CAACgF,YAAR,IAAwB,IAAxB,GACIlE,OAAO,CAACC,OAAR,CAAgBf,OAAO,CAACgF,YAAxB,CADJ,GAEIR,aAAa,CAACO,UAAD,EAAa/E,OAAb,CAHZ,EAILN,IAJK,CAICE,OAAD,IAAY;IACjB,MAAMqF,SAAS,GAAGpB,QAAQ,CAACqB,aAAT,CAAuB,OAAvB,CAAlB;IACA,MAAMC,YAAY,GAAGtB,QAAQ,CAACuB,cAAT,CAAwBxF,OAAxB,CAArB;IAEAqF,SAAS,CAACI,WAAV,CAAsBF,YAAtB;;IAEA,IAAIJ,UAAU,CAACO,UAAf,EAA2B;MACzBP,UAAU,CAACQ,YAAX,CAAwBN,SAAxB,EAAmCF,UAAU,CAACO,UAA9C;IACD,CAFD,MAEO;MACLP,UAAU,CAACM,WAAX,CAAuBJ,SAAvB;IACD;;IAED,OAAOF,UAAP;EACD,CAjBM,CAAP;AAkBD","names":["toArray","shouldEmbed","embedResources","cssFetchCache","fetchCSS","url","cache","deferred","window","fetch","then","res","cssText","text","embedFonts","meta","options","raw","regexUrl","fontLocs","match","loadFonts","map","location","replace","startsWith","URL","href","fetchRequestInit","blob","Promise","resolve","reject","reader","FileReader","onloadend","result","onerror","readAsDataURL","all","parseCSS","source","commentsRegex","keyframesRegex","RegExp","matches","exec","push","importRegex","combinedCSSRegex","unifiedRegex","lastIndex","getCSSRules","styleSheets","ret","deferreds","forEach","sheet","cssRules","item","index","type","CSSRule","IMPORT_RULE","importIndex","metadata","rule","insertRule","length","error","console","catch","e","toString","inline","find","a","document","err","getWebFontRules","filter","FONT_FACE_RULE","style","getPropertyValue","parseWebFontRules","node","ownerDocument","Error","getWebFontCSS","rules","baseUrl","parentStyleSheet","cssTexts","join","embedWebFonts","clonedNode","fontEmbedCSS","styleNode","createElement","sytleContent","createTextNode","appendChild","firstChild","insertBefore"],"sourceRoot":"","sources":["../src/embedWebFonts.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}